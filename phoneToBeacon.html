<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Advertisement Scanner</title>
</head>
<body>
    <h1>Bluetooth Advertisement Scanner</h1>
    <button id="startScanButton">Start Watching Advertisements</button>
    <button id="listDevicesButton">List Paired Devices</button>
    <p id="status">Status: Ready</p>
    <ul id="info-list"></ul>

    <script>
        const statusElement = document.getElementById('status');
        const infoList = document.getElementById('info-list');

        function updateStatus(message) {
            statusElement.textContent = `Status: ${message}`;
        }

        function addInfo(message) {
            const li = document.createElement('li');
            li.textContent = message;
            infoList.appendChild(li);
        }

        document.getElementById('startScanButton').addEventListener('click', async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['battery_service'] // Replace with additional service UUIDs if needed
                });

                updateStatus(`Selected device: ${device.name}`);
                addInfo(`Device selected: ${device.name || 'Unknown Device'}`);

                // Start watching advertisements
                await device.watchAdvertisements();

                device.addEventListener('advertisementreceived', (event) => {
                    console.log('Advertisement received:', event);
                    const deviceName = event.device.name || 'Unknown Device';
                    addInfo(`Advertisement from: ${deviceName}`);
                    updateStatus(`Received advertisement from: ${deviceName}`);

                    // Parse beacon data (example for Eddystone & iBeacon)
                    const manufacturerData = event.manufacturerData;
                    for (const [key, value] of manufacturerData) {
                        const data = new Uint8Array(value.buffer);
                        console.log(`Manufacturer ID: ${key}, Data:`, data);

                        if (isEddystoneBeacon(data)) {
                            addInfo(`Eddystone beacon detected: ${parseEddystone(data)}`);
                        } else if (isIBeacon(data)) {
                            addInfo(`iBeacon detected: ${parseIBeacon(data)}`);
                        } else {
                            addInfo('Unknown beacon format detected.');
                        }
                    }
                });
            } catch (error) {
                console.error('Error watching advertisements:', error);
                updateStatus('Error watching advertisements.');
            }
        });

        document.getElementById('listDevicesButton').addEventListener('click', async () => {
            try {
                const devices = await navigator.bluetooth.getDevices();
                updateStatus('Paired devices listed.');
                devices.forEach((device) => {
                    console.log('Paired device:', device);
                    addInfo(`Paired Device: ${device.name || 'Unnamed Device'} (ID: ${device.id})`);
                });
            } catch (error) {
                console.error('Error getting paired devices:', error);
                updateStatus('Error getting paired devices.');
            }
        });

        // Utility functions for detecting beacon types
        function isEddystoneBeacon(data) {
            // Eddystone beacons typically start with a specific byte pattern
            return data[0] === 0xaa && data[1] === 0xfe; // Check Eddystone Prefix
        }

        function parseEddystone(data) {
            const frameType = data[2];
            if (frameType === 0x10) {
                const url = parseEddystoneURL(data);
                return `Eddystone-URL: ${url}`;
            }
            return 'Eddystone beacon detected but not URL frame.';
        }

        function parseEddystoneURL(data) {
            const urlPrefix = ['http://www.', 'https://www.', 'http://', 'https://'];
            const encodedURL = [
                '.com/', '.org/', '.edu/', '.net/', '.info/', '.biz/', '.gov/',
                '.com', '.org', '.edu', '.net', '.info', '.biz', '.gov'
            ];

            const prefix = urlPrefix[data[4]];
            let url = prefix;
            for (let i = 5; i < data.length; i++) {
                const char = data[i];
                url += char < encodedURL.length ? encodedURL[char] : String.fromCharCode(char);
            }
            return url;
        }

        function isIBeacon(data) {
            // iBeacon identifiers typically follow Apple's format
            return data.length >= 23 && data[0] === 0x4c && data[1] === 0x00; // Apple manufacturer ID
        }

        function parseIBeacon(data) {
            const uuid = Array.from(data.slice(2, 18)).map(byte => byte.toString(16).padStart(2, '0')).join('');
            const major = (data[18] << 8) | data[19];
            const minor = (data[20] << 8) | data[21];
            return `UUID: ${uuid}, Major: ${major}, Minor: ${minor}`;
        }
    </script>
</body>
</html>
